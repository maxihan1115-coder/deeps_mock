// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  uuid      Int      @unique
  startDate DateTime? // 퀘스트 시작 시간 추가
  createdAt DateTime @default(now())
  lastLoginAt DateTime @default(now())

  // Relations
  attendanceRecords AttendanceRecord[]
  gameStates       GameState[]
  highScores       HighScore[]
  questProgresses  QuestProgress[]
  questParticipations QuestParticipation[] // 추가
  currencies       UserCurrency[]
  transactions     CurrencyTransaction[]
  shopPurchases    ShopPurchase[]
  gachaPurchases   GachaPurchase[]
  rankings         Ranking[]
  circleWallet     CircleWallet? // Circle USDC 지갑
  externalWallets ExternalWallet[]
  paymentHistory  PaymentHistory[]

  @@map("users")
}

model AttendanceRecord {
  id        String   @id @default(uuid())
  userId    Int      // User.uuid (숫자) 참조
  date      String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)

  @@map("attendance_records")
}


// 공통 퀘스트 카탈로그 (모든 유저가 공유하는 정의)
model QuestCatalog {
  id          String   @id // 고정 id (예: '1' ~ '12')
  title       String
  description String
  type        QuestType
  maxProgress Int
  reward      Int
  createdAt   DateTime @default(now())

  @@map("quest_catalog")
}

// 유저별 퀘스트 진행도 (활성화 이후 진행만 저장)
model QuestProgress {
  id            String   @id @default(uuid())
  userId        Int      // User.uuid 참조
  catalogId     String   // QuestCatalog.id 참조
  progress      Int      @default(0)
  isCompleted   Boolean  @default(false)
  lastResetTime DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User          @relation(fields: [userId], references: [uuid], onDelete: Cascade)

  @@unique([userId, catalogId])
  @@index([userId, isCompleted]) // 퀘스트 상태별 조회 최적화
  @@map("quest_progress")
}

model GameState {
  id        String   @id @default(uuid())
  userId    Int      @unique // User.uuid (숫자) 참조
  board     String   // JSON string
  score     Int      @default(0)
  level     Int      @default(1)
  lines     Int      @default(0)
  isGameOver Boolean  @default(false)
  isPaused  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)

  @@map("game_states")
}

model TempCode {
  id        String   @id @default(uuid())
  code      String   @unique
  userId    Int      // User.uuid (숫자) 참조
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("temp_codes")
}

model HighScore {
  id        String   @id @default(uuid())
  userId    Int      // User.uuid (숫자) 참조
  score     Int
  level     Int
  lines     Int
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)

  @@unique([userId])
  @@map("high_scores")
}

model PlatformLink {
  id            String   @id @default(uuid())
  gameUuid      Int      @unique // 게임 UUID (연동된 게임 계정)
  platformUuid  String   // 플랫폼 UUID (연동된 플랫폼 계정)
  platformType  String   // 플랫폼 타입 (예: "quest_service", "game_service")
  linkedAt      DateTime @default(now())
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("platform_links")
}

model PlatformLinkHistory {
  id            String   @id @default(uuid())
  gameUuid      Int      // 게임 UUID (재연동 방지를 위한 이력)
  platformUuid  String   // 플랫폼 UUID
  platformType  String   // 플랫폼 타입
  action        String   // 액션 타입 (CONNECT, DISCONNECT)
  linkedAt      DateTime // 연동 시점
  disconnectedAt DateTime? // 해제 시점
  createdAt     DateTime @default(now())

  @@map("platform_link_history")
}

model QuestParticipation {
  id        String   @id @default(uuid())
  gameUuid  Int      // 게임 UUID
  startDate DateTime // 퀘스트 참여 시작 시간
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // User 테이블과의 관계 추가
  user User @relation(fields: [gameUuid], references: [uuid], onDelete: Cascade)
  
  @@unique([gameUuid]) // gameUuid에 대한 고유 인덱스 추가
  @@map("quest_participation")
}

// 사용자 재화 정보
model UserCurrency {
  id        String   @id @default(uuid())
  userId    Int      // User.uuid 참조
  gold      Int      @default(0)      // 무료재화 (골드)
  diamond   Int      @default(0)      // 유료재화 (다이아)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)
  
  @@unique([userId])
  @@map("user_currencies")
}

// 재화 거래 내역
model CurrencyTransaction {
  id                   String   @id @default(uuid())
  userId               Int      // User.uuid 참조
  type                 CurrencyType
  amount               Int      // 양수: 획득, 음수: 소모
  reason               String   // 거래 사유
  gameScore            Int?     // 게임 점수 (골드 획득 시)
  circleTransactionId  String?  // Circle API 트랜잭션 ID (환전 시)
  txHash               String?  // 블록체인 트랜잭션 해시 (환전 시)
  createdAt            DateTime @default(now())

  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)
  
  @@map("currency_transactions")
}

// 상점 아이템
model ShopItem {
  id          String   @id @default(uuid())
  name        String   // 아이템 이름
  description String?  // 아이템 설명
  price       Int      // 가격
  currency    CurrencyType // GOLD 또는 DIAMOND
  isActive    Boolean  @default(true) // 판매 중인지 여부
  isGacha     Boolean  @default(false) // 가챠 아이템 여부
  gachaRewards Json?   // 가챠 보상 정보 (JSON 형태)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 구매 내역
  purchases   ShopPurchase[]
  gachaPurchases GachaPurchase[]
  
  @@map("shop_items")
}

// 상점 구매 내역
model ShopPurchase {
  id        String   @id @default(uuid())
  userId    Int      // User.uuid 참조
  itemId    String   // ShopItem.id 참조
  price     Int      // 구매 가격
  currency  CurrencyType // 사용한 재화 타입
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)
  item ShopItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@map("shop_purchases")
}

// 가챠 구매 내역
model GachaPurchase {
  id            String   @id @default(uuid())
  userId        Int      // User.uuid 참조
  gachaItemId   String   // ShopItem.id 참조 (가챠 아이템)
  diamondCost   Int      // 구매에 사용한 다이아몬드
  earnedDiamonds Int     // 획득한 다이아몬드
  createdAt     DateTime @default(now())
  
  user User @relation(fields: [userId], references: [uuid], onDelete: Cascade)
  gachaItem ShopItem @relation(fields: [gachaItemId], references: [id], onDelete: Cascade)
  
  @@map("gacha_purchases")
}

// 랭킹 테이블
model Ranking {
  id              BigInt   @id @default(autoincrement())
  userId          String   // User.id 참조
  gameUuid        Int      // User.uuid 참조
  score           Int
  level           Int
  lines           Int
  rankingPeriod   String   // 'daily', 'weekly', 'monthly', 'season'
  periodStartDate DateTime
  periodEndDate   DateTime
  rankPosition    Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, rankingPeriod, periodStartDate], map: "idx_user_period")
  @@unique([userId, rankingPeriod, periodStartDate], map: "uniq_user_period")
  @@index([rankingPeriod, periodStartDate, rankPosition], map: "idx_period_rank")
  @@index([rankingPeriod, periodStartDate, score], map: "idx_period_score") // 점수순 정렬 최적화
  @@index([gameUuid], map: "idx_game_uuid")
  @@map("rankings")
}

enum CurrencyType {
  GOLD
  DIAMOND
}

enum QuestType {
  DAILY
  WEEKLY
  MONTHLY
  SINGLE
  PURCHASE
  RANKING
}

// Circle USDC Integration Models

// Circle 지갑 모델
model CircleWallet {
  id              String   @id @default(uuid())
  userId          Int      @unique // User.uuid 참조
  walletSetId     String   // Circle Wallet Set ID
  walletId        String   @unique // Circle Wallet ID
  address         String   // 블록체인 주소 (0x...)
  blockchain      String   // MATIC-AMOY, MATIC-MAINNET 등
  accountType     String   @default("EOA") // EOA or SCA
  state           String   // LIVE, FROZEN 등
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [uuid], onDelete: Cascade)
  transactions    CircleTransaction[]

  @@map("circle_wallets")
}

// Circle 트랜잭션 모델
model CircleTransaction {
  id                String   @id @default(uuid())
  userId            Int      // User.uuid 참조
  walletId          String   // CircleWallet.walletId
  circleTransactionId String @unique // Circle API 트랜잭션 ID
  type              CircleTransactionType
  status            CircleTransactionStatus
  amount            String   // USDC 금액 (문자열로 저장, 정확성)
  tokenId           String   // USDC-AMOY, USDC 등
  blockchain        String   // MATIC-AMOY 등
  fromAddress       String?  // 송신자 주소
  toAddress         String   // 수신자 주소
  txHash            String?  // 블록체인 트랜잭션 해시
  relatedGameUuid   Int?     // 관련 사용자 (송금 시)
  metadata          Json?    // 추가 메타데이터
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  wallet            CircleWallet @relation(fields: [walletId], references: [walletId], onDelete: Cascade)

  @@map("circle_transactions")
}

// USDC 잔액 캐시 (성능 최적화용)
model USDCBalance {
  id        String   @id @default(uuid())
  userId    Int      @unique // User.uuid 참조
  walletId  String   // CircleWallet.walletId
  balance   String   // USDC 잔액 (문자열)
  updatedAt DateTime @updatedAt

  @@map("usdc_balances")
}

// 결제 내역 (다이아몬드 구매)
model PaymentHistory {
  id                  String        @id @default(uuid())
  userId              Int           // User.uuid 참조
  user                User          @relation(fields: [userId], references: [uuid])
  paymentMethod       PaymentMethod @default(USDC) // 결제 수단 (FIAT, USDC)
  circleTransactionId String?       // CircleTransaction.id (USDC 결제 시)
  diamondAmount       Int           // 구매한 다이아몬드 수량
  usdcAmount          String?       // 지불한 USDC (USDC 결제 시)
  fiatAmount          String?       // 지불한 법정화폐 금액 (일반 결제 시)
  currency            String?       // 법정화폐 통화 (KRW, USD 등)
  txHash              String?       // 블록체인 트랜잭션 해시 (USDC 결제 시)
  status              PaymentStatus
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId, createdAt])
  @@map("payment_history")
}

model ExternalWallet {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [uuid])
  address   String   @unique // 지갑 주소 (0x...) - 글로벌 unique 제약
  chain     String   // 연결된 체인 (e.g., "MATIC-AMOY")
  label     String?  // 지갑 별칭 (e.g., "MetaMask")
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, address])
  @@index([address])
  @@map("external_wallets")
}

model CardPayment {
  id                  String   @id @default(uuid())
  userId              Int
  circlePaymentId     String   @unique // Circle Payment ID
  amount              String   // 결제 금액 (USD)
  usdcAmount          String   // 지급된 USDC 양
  status              String   // PENDING, CONFIRMED, FAILED
  cardId              String?  // Circle Card ID
  toAddress           String   // 지급된 지갑 주소
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("card_payments")
}

enum CircleTransactionType {
  DIAMOND_PURCHASE  // 다이아몬드 구매
  P2P_TRANSFER      // P2P 송금
  DEPOSIT           // 입금
  WITHDRAWAL        // 출금
}

enum CircleTransactionStatus {
  PENDING           // 대기 중
  QUEUED            // 큐에 추가됨
  SENT              // 전송됨
  COMPLETE          // 완료
  FAILED            // 실패
  CANCELLED         // 취소됨
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  FIAT  // 일반 결제 (원화 등)
  USDC  // USDC 결제
}

